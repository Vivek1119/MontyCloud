version: "3.9"

services:
  app:
    build: .
    container_name: fastapi-app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000"
    environment:
      # AWS configuration for LocalStack
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ENDPOINT_URL=http://localstack:4566

      # Your service environment variables
      - S3_BUCKET=image-bucket
      - DYNAMO_TABLE=image_metadata

    depends_on:
      - localstack
    volumes:
      - .:/app
    working_dir: /app
    restart: unless-stopped

  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    ports:
      - "4566:4566"  # Gateway for all LocalStack AWS services
    environment:
      - SERVICES=s3,dynamodb
      - AWS_DEFAULT_REGION=us-east-1
      - DEBUG=1
    volumes:
      - "./init_localstack.sh:/etc/localstack/init/ready.d/init_localstack.sh"
      - "localstack_data:/var/lib/localstack"
    restart: unless-stopped

volumes:
  localstack_data:
